<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTI 조명 돔 AR 인터페이스</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        input, textarea {
            width: 100%;
            padding: 5px;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 12px;
        }
        
        textarea {
            height: 60px;
            resize: vertical;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-size: 12px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #flash-btn {
            background: #ff4444;
        }
        
        #flash-btn:hover {
            background: #cc3333;
        }
        
        #flash-btn.on {
            background: #ffaa00;
        }
        
        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-size: 12px;
        }
        
        #info-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 200;
            text-align: center;
            display: none;
        }
        
        .hide-controls {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        #toggle-controls {
            position: absolute;
            top: 20px;
            left: 350px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 101;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="controls">
            <h3 style="margin-top: 0;">RTI 조명 돔 설정</h3>
            
            <div class="control-group">
                <label>대상 실제 크기 (mm):</label>
                <input type="number" id="objectSize" value="100" min="1" max="1000">
            </div>
            
            <div class="control-group">
                <label>돔 반지름 배율 (2-4배):</label>
                <input type="number" id="domeRadius" value="3" min="2" max="4" step="0.1">
            </div>
            
            <div class="control-group">
                <label>방위각 리스트 (°, 콤마 구분):</label>
                <textarea id="azimuthList" placeholder="0,45,90,135,180,225,270,315">0,45,90,135,180,225,270,315</textarea>
            </div>
            
            <div class="control-group">
                <label>고도각 리스트 (°, 콤마 구분):</label>
                <textarea id="elevationList" placeholder="15,30,45,60,75">15,30,45,60,75</textarea>
            </div>
            
            <button onclick="generateDome()">돔 생성</button>
            <button onclick="startAR()" id="ar-btn">AR 시작</button>
            <button onclick="toggleFlash()" id="flash-btn">플래시 OFF</button>
            <button onclick="resetView()">뷰 리셋</button>
            <button onclick="requestPermissions()">권한 요청</button>
        </div>
        
        <button id="toggle-controls" onclick="toggleControls()">◀</button>
        
        <div id="status">
            WebXR 지원 확인 중...
        </div>
        
        <div id="info-panel">
            <h3 id="marker-info"></h3>
            <button onclick="hideInfo()">닫기</button>
        </div>
    </div>

    <script>
        let scene, camera, renderer, dome, markers = [], labelSprites = [];
        let isARActive = false;
        let flashOn = false;
        let isDragging = false;
        let dragStart = new THREE.Vector2();
        let domePosition = new THREE.Vector3();
        let controlsHidden = false;
        
        // 씬 초기화
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.setClearColor(0x000000, 0);
            
            document.getElementById('container').appendChild(renderer.domElement);
            
            // 조명 설정
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // 카메라 초기 위치
            camera.position.set(0, 1.6, 3);
            camera.lookAt(0, 0, 0);
            
            // 바닥 격자 추가
            const gridHelper = new THREE.GridHelper(10, 20, 0x444444, 0x444444);
            scene.add(gridHelper);
            
            // 마우스/터치 이벤트
            setupInteraction();
            
            animate();
        }
        
        // 돔 생성 함수
        function generateDome() {
            clearDome();
            
            const objectSize = parseFloat(document.getElementById('objectSize').value);
            const radiusMultiplier = parseFloat(document.getElementById('domeRadius').value);
            const azimuthStr = document.getElementById('azimuthList').value;
            const elevationStr = document.getElementById('elevationList').value;
            
            if (!objectSize || !radiusMultiplier || !azimuthStr || !elevationStr) {
                alert('모든 필드를 입력해주세요.');
                return;
            }
            
            const azimuths = azimuthStr.split(',').map(a => parseFloat(a.trim())).filter(a => !isNaN(a));
            const elevations = elevationStr.split(',').map(e => parseFloat(e.trim())).filter(e => !isNaN(e));
            
            if (azimuths.length === 0 || elevations.length === 0) {
                alert('유효한 각도 값을 입력해주세요.');
                return;
            }
            
            // 돔 반지름 계산 (mm를 m로 변환)
            const domeRadius = (objectSize * radiusMultiplier) / 1000;
            
            // 반구 돔 생성
            const domeGeometry = new THREE.SphereGeometry(domeRadius, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2);
            const domeMaterial = new THREE.MeshLambertMaterial({
                color: 0x000000,
                transparent: true,
                opacity: 0.3,
                side: THREE.DoubleSide
            });
            
            dome = new THREE.Mesh(domeGeometry, domeMaterial);
            dome.position.copy(domePosition);
            scene.add(dome);
            
            // 조명 마커 생성
            azimuths.forEach(azimuth => {
                elevations.forEach(elevation => {
                    createLightMarker(azimuth, elevation, domeRadius);
                });
            });
            
            updateStatus(`돔 생성 완료: ${markers.length}개 마커, 반지름 ${(domeRadius * 1000).toFixed(1)}mm`);
        }
        
        // 조명 마커 생성
        function createLightMarker(azimuth, elevation, domeRadius) {
            const azimuthRad = (azimuth * Math.PI) / 180;
            const elevationRad = (elevation * Math.PI) / 180;
            
            // 구면 좌표를 직교 좌표로 변환
            const x = domeRadius * Math.cos(elevationRad) * Math.cos(azimuthRad);
            const z = domeRadius * Math.cos(elevationRad) * Math.sin(azimuthRad);
            const y = domeRadius * Math.sin(elevationRad);
            
            // 마커 구체 생성 (노란색으로 변경)
            const markerGeometry = new THREE.SphereGeometry(0.02, 12, 12);
            const markerMaterial = new THREE.MeshBasicMaterial({
                color: 0xffff00,
                emissive: 0x444400
            });
            
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.set(x, y, z);
            marker.position.add(domePosition);
            marker.userData = { azimuth, elevation };
            
            scene.add(marker);
            markers.push(marker);
        }
        
        // 상호작용 설정
        function setupInteraction() {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            function onPointerDown(event) {
                if (isARActive) return;
                
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                
                // 마커 클릭 확인
                const markerIntersects = raycaster.intersectObjects(markers);
                if (markerIntersects.length > 0) {
                    const marker = markerIntersects[0].object;
                    showMarkerInfo(marker.userData.azimuth, marker.userData.elevation);
                    return;
                }
                
                // 돔 드래그 시작
                if (dome) {
                    const domeIntersects = raycaster.intersectObject(dome);
                    if (domeIntersects.length > 0) {
                        isDragging = true;
                        dragStart.set(mouse.x, mouse.y);
                    }
                }
            }
            
            function onPointerMove(event) {
                if (!isDragging || isARActive) return;
                
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                const deltaX = (mouse.x - dragStart.x) * 2;
                const deltaY = (mouse.y - dragStart.y) * 2;
                
                // 돔과 마커 이동
                const moveVector = new THREE.Vector3(deltaX, 0, deltaY);
                domePosition.add(moveVector);
                
                if (dome) {
                    dome.position.copy(domePosition);
                }
                
                markers.forEach(marker => {
                    marker.position.add(moveVector);
                });
                
                dragStart.set(mouse.x, mouse.y);
            }
            
            function onPointerUp() {
                isDragging = false;
            }
            
            renderer.domElement.addEventListener('pointerdown', onPointerDown);
            renderer.domElement.addEventListener('pointermove', onPointerMove);
            renderer.domElement.addEventListener('pointerup', onPointerUp);
            
            // 터치 이벤트
            renderer.domElement.addEventListener('touchstart', (e) => {
                e.preventDefault();
                onPointerDown(e.touches[0]);
            });
            
            renderer.domElement.addEventListener('touchmove', (e) => {
                e.preventDefault();
                onPointerMove(e.touches[0]);
            });
            
            renderer.domElement.addEventListener('touchend', (e) => {
                e.preventDefault();
                onPointerUp();
            });
        }
        
        // 마커 정보 표시
        function showMarkerInfo(azimuth, elevation) {
            document.getElementById('marker-info').textContent = `방위각: ${azimuth}°, 고도각: ${elevation}°`;
            document.getElementById('info-panel').style.display = 'block';
        }
        
        function hideInfo() {
            document.getElementById('info-panel').style.display = 'none';
        }
        
        // AR 시작
        async function startAR() {
            if (!navigator.xr) {
                updateStatus('WebXR을 지원하지 않는 브라우저입니다.');
                return;
            }
            
            try {
                // 더 포괄적인 AR 세션 요청
                const sessionInit = {
                    requiredFeatures: ['local'],
                    optionalFeatures: ['dom-overlay', 'hit-test', 'anchors']
                };
                
                const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
                
                // AR 세션 설정
                await renderer.xr.setSession(session);
                isARActive = true;
                
                // 세션 이벤트 리스너
                session.addEventListener('end', () => {
                    isARActive = false;
                    document.getElementById('ar-btn').textContent = 'AR 시작';
                    document.getElementById('ar-btn').onclick = startAR;
                    updateStatus('AR 세션 종료됨');
                });
                
                // 레퍼런스 스페이스 설정
                const referenceSpace = await session.requestReferenceSpace('local');
                
                document.getElementById('ar-btn').textContent = 'AR 종료';
                document.getElementById('ar-btn').onclick = stopAR;
                
                updateStatus('AR 모드 활성화 - 카메라 화면이 표시됩니다');
                
                // 컨트롤 패널 숨기기 (AR 모드에서)
                if (!controlsHidden) {
                    toggleControls();
                }
                
            } catch (error) {
                console.error('AR 시작 오류:', error);
                updateStatus('AR 세션 시작 실패: ' + error.message);
                
                // WebXR Device API 지원 확인
                if (error.name === 'NotSupportedError') {
                    updateStatus('이 디바이스는 WebXR AR을 지원하지 않습니다.');
                } else if (error.name === 'NotAllowedError') {
                    updateStatus('AR 권한이 거부되었습니다. 브라우저 설정을 확인해주세요.');
                }
            }
        }
        
        function stopAR() {
            if (renderer.xr.getSession()) {
                renderer.xr.getSession().end();
            }
            isARActive = false;
            document.getElementById('ar-btn').textContent = 'AR 시작';
            document.getElementById('ar-btn').onclick = startAR;
            updateStatus('AR 모드 종료');
        }
        
        // 권한 요청 함수 추가
        async function requestPermissions() {
            try {
                if ('permissions' in navigator) {
                    const cameraPermission = await navigator.permissions.query({name: 'camera'});
                    updateStatus(`카메라 권한: ${cameraPermission.state}`);
                }
                
                // 미디어 권한 요청 (카메라 액세스를 위해)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                // 스트림 즉시 중지 (권한 확인용)
                stream.getTracks().forEach(track => track.stop());
                
                updateStatus('카메라 권한 허용됨 - AR을 시도해보세요');
                
            } catch (error) {
                updateStatus('권한 요청 실패: ' + error.message);
            }
        }
        
        // 플래시 토글
        function toggleFlash() {
            flashOn = !flashOn;
            const btn = document.getElementById('flash-btn');
            
            if (flashOn) {
                btn.textContent = '플래시 ON';
                btn.classList.add('on');
                // 플래시 ON일 때 더 밝은 노란색
                markers.forEach(marker => {
                    marker.material.color.setHex(0xffff88);
                    marker.material.emissive.setHex(0x666600);
                });
            } else {
                btn.textContent = '플래시 OFF';
                btn.classList.remove('on');
                // 플래시 OFF일 때 기본 노란색
                markers.forEach(marker => {
                    marker.material.color.setHex(0xffff00);
                    marker.material.emissive.setHex(0x444400);
                });
            }
            
            updateStatus(`플래시 ${flashOn ? 'ON' : 'OFF'}`);
        }
        
        // 뷰 리셋
        function resetView() {
            camera.position.set(0, 1.6, 3);
            camera.lookAt(0, 0, 0);
            domePosition.set(0, 0, 0);
            
            if (dome) {
                dome.position.copy(domePosition);
            }
            
            // 마커 위치도 리셋
            if (markers.length > 0) {
                generateDome();
            }
            
            updateStatus('뷰 리셋 완료');
        }
        
        // 컨트롤 토글
        function toggleControls() {
            const controls = document.getElementById('controls');
            const toggleBtn = document.getElementById('toggle-controls');
            
            controlsHidden = !controlsHidden;
            
            if (controlsHidden) {
                controls.classList.add('hide-controls');
                toggleBtn.textContent = '▶';
                toggleBtn.style.left = '20px';
            } else {
                controls.classList.remove('hide-controls');
                toggleBtn.textContent = '◀';
                toggleBtn.style.left = '350px';
            }
        }
        
        // 돔과 마커 제거
        function clearDome() {
            if (dome) {
                scene.remove(dome);
                dome = null;
            }
            
            markers.forEach(marker => scene.remove(marker));
            markers = [];
            
            labelSprites.forEach(sprite => scene.remove(sprite));
            labelSprites = [];
        }
        
        // 상태 업데이트
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // 애니메이션 루프
        function animate() {
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });
        }
        
        // 윈도우 리사이즈 처리
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        // WebXR 지원 확인
        async function checkWebXRSupport() {
            if (!navigator.xr) {
                updateStatus('WebXR을 지원하지 않는 브라우저입니다. Chrome 79+ 필요');
                return;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    updateStatus('WebXR AR 지원됨 - AR을 시작할 수 있습니다.');
                    
                    // 추가 권한 및 기능 확인
                    if ('permissions' in navigator) {
                        const cameraPermission = await navigator.permissions.query({name: 'camera'});
                        console.log('카메라 권한:', cameraPermission.state);
                    }
                    
                } else {
                    updateStatus('WebXR AR을 지원하지 않습니다. Chrome에서 chrome://flags/#webxr-incubations 활성화 필요');
                }
            } catch (error) {
                console.error('WebXR 확인 오류:', error);
                updateStatus('WebXR 지원 확인 중 오류: ' + error.message);
            }
        }
        
        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            initScene();
            checkWebXRSupport();
            generateDome(); // 기본 돔 생성
        });
    </script>
</body>
</html>
